# Plan 14-04: Background Progress Pipeline

**Phase:** 14 - Smart Progress Tracking
**Plan:** 4 of 5
**Created:** 2026-01-20
**Estimated effort:** Small (1-2 hours)

---

## Objective

Create the `ProgressPipeline` class that orchestrates background progress analysis with:
- DispatchSourceTimer for 45-minute background processing intervals
- Daily token limit enforcement (50k default, half of priority budget)
- Staleness detection cycle for items with 3+ days without activity
- Retry logic with exponential backoff for API resilience
- Integration with AIManager for lifecycle management

## Dependencies

- **AIProgress.swift** - Progress models (ProgressState, ProgressScore, etc.)
- **ProgressAnalysisService.swift** - LLM-based progress analysis
- **ProgressSignalExtractor.swift** - Rule-based signal extraction
- **DatabaseService.swift** - Progress score storage and retrieval
- **PriorityPipeline.swift** - Reference pattern for implementation

## Tasks

### Task 1: Create ProgressSettings.swift

Create settings singleton for progress pipeline configuration:
- Daily token limit (default: 50,000 - half of priority budget)
- Processing interval (default: 45 minutes)
- Staleness threshold (default: 3 days)
- Model selection (default: GPT-5.2 Nano)
- UserDefaults-backed with Combine publishing

**File:** `Beacon/Services/AI/ProgressSettings.swift`

### Task 2: Create ProgressPipeline.swift

Create the main pipeline class following PriorityPipeline pattern:

**Components:**
1. DispatchSourceTimer on utility queue for 45-minute intervals
2. Daily token limit enforcement (50k default)
3. Staleness detection cycle (items in_progress for 3+ days)
4. Exponential backoff retry logic (max 3 attempts, 1-30s delay)
5. Integration points for AIManager

**Key methods:**
- `start()` - Begin background processing
- `stop()` - Stop background processing
- `triggerNow()` - Immediate processing
- `runProcessingCycle()` - Core processing logic
- `detectStaleItems()` - Check for items becoming stale
- `withRetry()` - Exponential backoff helper

**File:** `Beacon/Services/AI/ProgressPipeline.swift`

### Task 3: Integrate into AIManager.swift

Add ProgressPipeline to AIManager:
- Property for pipeline instance
- Start/stop methods
- Statistics accessor
- Configuration methods (daily limit, etc.)
- Progress score retrieval helpers

### Task 4: Verify Build

Run `xcodebuild` to ensure all changes compile successfully.

## Success Criteria

1. ProgressPipeline.swift created with all specified functionality
2. ProgressSettings.swift created for configuration management
3. AIManager.swift updated with pipeline integration
4. Build succeeds with no errors
5. Code follows existing patterns (PriorityPipeline reference)

## File Changes

| File | Change Type | Description |
|------|-------------|-------------|
| `Services/AI/ProgressSettings.swift` | New | Settings singleton for pipeline configuration |
| `Services/AI/ProgressPipeline.swift` | New | Background processing pipeline |
| `Services/AI/AIManager.swift` | Modify | Pipeline integration and lifecycle management |

## Technical Notes

- 45-minute interval chosen as progress changes less frequently than priority
- 50k daily token limit is half of priority (100k) to balance API costs
- Staleness threshold of 3 days matches research recommendation
- Uses existing cost logging infrastructure (beacon_priority_cost_log)
- Hybrid analysis (heuristics + LLM) reduces API calls by ~60%
