---
phase: 11-teams-integration
plan: 02
type: execute
wave: 2
depends_on: ["11-01"]
files_modified: [Models/TeamsMessage.swift, Auth/AuthManager.swift, ViewModels/UnifiedTasksViewModel.swift]
autonomous: true
---

<objective>
Create TeamsMessage model and integrate Teams into the unified task system.

Purpose: Connect TeamsService to the app's data flow so Teams messages appear in the task list.
Output: Teams messages fetched and displayed alongside ADO work items, Outlook, and Gmail emails.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-teams-integration/11-01-SUMMARY.md

# Reference existing patterns:
@Beacon/Models/Email.swift
@Beacon/Models/UnifiedTask.swift
@Beacon/Auth/AuthManager.swift
@Beacon/ViewModels/UnifiedTasksViewModel.swift
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TeamsMessage model conforming to UnifiedTask</name>
  <files>Models/TeamsMessage.swift</files>
  <action>
Create new file `Models/TeamsMessage.swift` with a struct that conforms to UnifiedTask protocol:

```swift
struct TeamsMessage: UnifiedTask {
    let id: String
    let chatId: String
    let chatTopic: String?
    let senderName: String
    let content: String
    let createdAt: Date
    let isUrgent: Bool
    let webUrl: String?

    // UnifiedTask conformance
    var taskId: String { id }
    var taskTitle: String { content.prefix(100) + (content.count > 100 ? "..." : "") }
    var taskSource: TaskSource { .teams }
    var taskPriority: TaskPriority { isUrgent ? .high : .medium }
    var taskDate: Date { createdAt }
    var taskDescription: String { "From: \(senderName)" + (chatTopic.map { " in \($0)" } ?? "") }
    var taskURL: URL? { webUrl.flatMap { URL(string: $0) } }
}
```

Also add `.teams` case to TaskSource enum (check where it's defined - likely in Models/ or as part of UnifiedTask).
  </action>
  <verify>swift build succeeds, TeamsMessage conforms to UnifiedTask</verify>
  <done>TeamsMessage model created with full UnifiedTask conformance</done>
</task>

<task type="auto">
  <name>Task 2: Wire TeamsService to AuthManager</name>
  <files>Auth/AuthManager.swift</files>
  <action>
Add TeamsService to AuthManager following the pattern of outlookService and gmailService:

1. Add lazy property:
```swift
private(set) lazy var teamsService: TeamsService = TeamsService(auth: microsoftAuth)
```

2. Add method to fetch Teams messages:
```swift
/// Fetch recent/urgent Teams messages
func getTeamsMessages() async throws -> [TeamsMessage] {
    let rawMessages = try await teamsService.getRecentMessages()
    return rawMessages.map { msg in
        TeamsMessage(
            id: msg.id,
            chatId: msg.chatId ?? "",
            chatTopic: nil, // Will be populated if we track chat info
            senderName: msg.from?.user?.displayName ?? "Unknown",
            content: msg.body?.content ?? "",
            createdAt: parseDate(msg.createdDateTime),
            isUrgent: msg.importance?.lowercased() == "urgent",
            webUrl: nil // Teams messages don't have direct web URLs
        )
    }
}
```

Add a private parseDate helper or reuse existing ISO8601 parsing.
  </action>
  <verify>swift build succeeds, getTeamsMessages method exists on AuthManager</verify>
  <done>AuthManager has teamsService property and getTeamsMessages method</done>
</task>

<task type="auto">
  <name>Task 3: Integrate Teams in UnifiedTasksViewModel</name>
  <files>ViewModels/UnifiedTasksViewModel.swift</files>
  <action>
Update loadAllTasks() to include Teams messages:

1. In the TaskGroup, add Teams fetching alongside ADO, Outlook, Gmail:
```swift
// Inside TaskGroup
if authManager.isMicrosoftSignedIn {
    // Existing ADO and Outlook fetches...

    // Add Teams fetch
    group.addTask {
        do {
            let messages = try await self.authManager.getTeamsMessages()
            return messages.map { $0 as any UnifiedTask }
        } catch {
            print("[Tasks] Teams fetch failed: \(error)")
            return []
        }
    }
}
```

2. Ensure Teams messages are included in the unified task list merge.

Note: Teams fetch only runs when Microsoft is signed in (reuses same auth token).
  </action>
  <verify>swift build succeeds, Teams messages would appear in task list</verify>
  <done>UnifiedTasksViewModel fetches Teams messages in loadAllTasks</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] swift build succeeds without errors
- [ ] Models/TeamsMessage.swift exists and conforms to UnifiedTask
- [ ] TaskSource has .teams case
- [ ] AuthManager.getTeamsMessages() method exists
- [ ] UnifiedTasksViewModel.loadAllTasks() includes Teams fetch
</verification>

<success_criteria>
- All tasks completed
- All verification checks pass
- Teams messages would appear in unified task list when Microsoft signed in
- Ready for UI integration in Plan 03
</success_criteria>

<output>
After completion, create `.planning/phases/11-teams-integration/11-02-SUMMARY.md`
</output>
